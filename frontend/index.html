<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="api-base-url" content="https://invent-ca-production.up.railway.app/" />
  <title>InventaTI ‚Äî Gesti√≥n de Activos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue:#1a56db;--blue-d:#1444b8;--blue-l:#e8f0fe;--blue-m:#c7d9fc;
      --slate:#18315A;--slate-m:#334155;--slate-l:#64748b;
      --border:#e2e8f0;--border-d:#cbd5e1;--bg:#f8fafc;--bg2:#ffffff;
      --text:#0f172a;--text2:#475569;--text3:#94a3b8;
      --success:#059669;--success-l:#d1fae5;--warning:#d97706;--warning-l:#fef3c7;
      --danger:#dc2626;--danger-l:#fee2e2;--orange:#ea580c;--orange-l:#ffedd5;
      --mono:'DM Mono',monospace;--sans:'DM Sans',sans-serif;
      --shadow:0 1px 3px rgba(0,0,0,0.08),0 1px 2px rgba(0,0,0,0.05);
      --shadow-m:0 4px 16px rgba(0,0,0,0.08),0 2px 6px rgba(0,0,0,0.05);
      --shadow-l:0 20px 60px rgba(0,0,0,0.12),0 8px 24px rgba(0,0,0,0.08);
      --radius:10px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    html{scroll-behavior:smooth;}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}
    #login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#f0f4ff 0%,#fafbff 50%,#f0f7ff 100%);position:relative;overflow:hidden;}
    #login-screen::before{content:'';position:absolute;width:800px;height:800px;background:radial-gradient(circle,rgba(26,86,219,0.06) 0%,transparent 70%);top:-200px;right:-200px;pointer-events:none;}
    .login-card{background:white;border-radius:16px;box-shadow:var(--shadow-l);padding:52px 48px;width:440px;border:1px solid var(--border);animation:fadeUp 0.4s ease;}
    .login-brand{display:flex;align-items:center;gap:10px;margin-bottom:32px;}
    .login-brand-icon{width:40px;height:40px;background:var(--blue);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;}
    .login-title{font-size:26px;font-weight:600;margin-bottom:8px;}
    .login-sub{font-size:14px;color:var(--text2);margin-bottom:32px;line-height:1.6;}
    /* Logo image handling (responsive + retina) üîß */
    .login-brand-icon img,
    .sidebar-brand-icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      border-radius:inherit;
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
    }
    /* Improve rendering on high-DPI screens */
    @media (-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
      .login-brand-icon img,
      .sidebar-brand-icon img{image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;}
    }
    .btn-google{display:flex;align-items:center;gap:12px;width:100%;padding:13px 20px;background:white;border:1.5px solid var(--border-d);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;text-decoration:none;justify-content:center;}
    .btn-google:hover{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-l);}
    .btn-google svg{width:20px;height:20px;flex-shrink:0;}
    .login-note{margin-top:20px;font-size:12px;color:var(--text3);text-align:center;}
    .error-banner{background:var(--danger-l);border:1px solid #fca5a5;color:var(--danger);padding:10px 14px;border-radius:6px;font-size:13px;margin-bottom:20px;display:none;}
    #app{display:none;}
    .layout{display:flex;height:100vh;overflow:hidden;}
    .sidebar{width:240px;flex-shrink:0;background:var(--slate);display:flex;flex-direction:column;overflow:hidden;}
    .sidebar-header{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,0.08);}
    .sidebar-brand{display:flex;align-items:center;gap:10px;}
    .sidebar-brand-icon{width:34px;height:34px;background:var(--blue);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:16px;flex-shrink:0;}
    .sidebar-brand-name{font-size:16px;font-weight:600;color:white;}
    .sidebar-brand-sub{font-size:10px;color:rgba(255,255,255,0.4);font-family:var(--mono);}
    .sidebar-nav{flex:1;padding:12px 8px;overflow-y:auto;}
    .nav-section{font-size:10px;letter-spacing:1.5px;color:rgba(255,255,255,0.3);text-transform:uppercase;padding:10px 10px 4px;margin-top:4px;font-family:var(--mono);}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;color:rgba(255,255,255,0.6);font-size:13.5px;cursor:pointer;border-radius:8px;transition:all 0.15s;font-weight:400;margin-bottom:1px;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.07);}
    .nav-item.active{color:white;background:var(--blue);font-weight:500;}
    .nav-item .ni{font-size:15px;flex-shrink:0;width:18px;text-align:center;}
    .sidebar-footer{padding:12px;border-top:1px solid rgba(255,255,255,0.08);}
    .user-row{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.05);}
    .user-ava{width:32px;height:32px;border-radius:50%;background:var(--blue);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-size:13px;font-weight:600;}
    .user-ava img{width:100%;height:100%;object-fit:cover;}
    .user-name{font-size:12px;font-weight:500;color:white;line-height:1.3;}
    .user-email{font-size:10px;color:rgba(255,255,255,0.4);}
    .btn-logout{width:100%;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;font-family:var(--sans);transition:all 0.2s;}
    .btn-logout:hover{border-color:rgba(220,38,38,0.5);color:#fca5a5;}
    .main{flex:1;overflow:hidden;display:flex;flex-direction:column;background:var(--bg);}
    .topbar{height:56px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:12px;flex-shrink:0;}
    .topbar-title{font-size:15px;font-weight:600;flex:1;}
    .search-box{display:flex;align-items:center;gap:8px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;width:260px;transition:all 0.2s;}
    .search-box:focus-within{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-l);background:white;}
    .search-box input{background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:var(--sans);width:100%;}
    .search-box input::placeholder{color:var(--text3);}
    .content{flex:1;overflow-y:auto;padding:24px;}
    .view{display:none;animation:fadeIn 0.2s ease;}
    .view.active{display:block;}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;margin-bottom:24px;}
    .stat-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:box-shadow 0.2s;}
    .stat-card:hover{box-shadow:var(--shadow-m);}
    .stat-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .stat-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .stat-icon.blue{background:var(--blue-l);color:var(--blue);}
    .stat-icon.green{background:var(--success-l);color:var(--success);}
    .stat-icon.yellow{background:var(--warning-l);color:var(--warning);}
    .stat-icon.red{background:var(--danger-l);color:var(--danger);}
    .stat-icon.orange{background:var(--orange-l);color:var(--orange);}
    .stat-value{font-size:32px;font-weight:600;font-family:var(--mono);color:var(--text);}
    .stat-label{font-size:12px;color:var(--text2);margin-top:2px;}
    .charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
    .chart-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);}
    .chart-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:16px;}
    .bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .bar-label{width:130px;font-size:12px;color:var(--text2);text-align:right;flex-shrink:0;}
    .bar-track{flex:1;height:8px;background:var(--bg);border-radius:99px;overflow:hidden;}
    .bar-fill{height:100%;background:var(--blue);border-radius:99px;transition:width 0.6s ease;}
    .bar-count{width:32px;text-align:right;font-size:12px;font-family:var(--mono);color:var(--text2);font-weight:500;}
    .table-card{background:white;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .table-toolbar{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
    .table-toolbar h2{font-size:14px;font-weight:600;flex:1;}
    .filter-group{display:flex;gap:8px;flex-wrap:wrap;}
    select.filter{background:white;border:1.5px solid var(--border);border-radius:6px;color:var(--text2);font-size:12px;padding:6px 10px;font-family:var(--sans);cursor:pointer;outline:none;transition:border-color 0.2s;}
    select.filter:focus{border-color:var(--blue);}
    .table-wrap{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    thead th{background:var(--bg);border-bottom:1px solid var(--border);padding:10px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;user-select:none;}
    tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;}
    tbody tr:last-child{border-bottom:none;}
    tbody tr:hover{background:#f8faff;}
    tbody td{padding:11px 14px;color:var(--text2);white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis;}
    .td-id{color:var(--blue);font-family:var(--mono);font-weight:500;font-size:12px;}
    .td-name{color:var(--text);font-weight:500;}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:99px;font-size:11px;font-weight:500;white-space:nowrap;}
    .badge::before{content:'‚óè';font-size:8px;}
    .badge-asignado{background:var(--blue-l);color:var(--blue);}
    .badge-oficina{background:var(--success-l);color:var(--success);}
    .badge-almacen{background:#f1f5f9;color:var(--slate-l);}
    .badge-reparacion{background:var(--warning-l);color:var(--warning);}
    .badge-baja{background:var(--danger-l);color:var(--danger);}
    .badge-activo{background:var(--success-l);color:var(--success);}
    .badge-inactivo{background:#f1f5f9;color:var(--slate-l);}
    .badge-cesado{background:var(--danger-l);color:var(--danger);}
    .link-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:500;color:var(--blue);background:var(--blue-l);text-decoration:none;transition:background 0.15s;margin-right:3px;}
    .link-pill:hover{background:var(--blue-m);}
    .action-row{display:flex;gap:4px;align-items:center;}
    .btn-icon{width:30px;height:30px;border:none;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;background:transparent;color:var(--text3);}
    .btn-icon:hover{background:var(--bg);color:var(--text);}
    .btn-icon.view:hover{background:var(--blue-l);color:var(--blue);}
    .btn-icon.edit:hover{background:var(--warning-l);color:var(--warning);}
    .btn-icon.del:hover{background:var(--danger-l);color:var(--danger);}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:13px;font-family:var(--sans);font-weight:500;cursor:pointer;border:none;transition:all 0.15s;white-space:nowrap;}
    .btn-primary{background:var(--blue);color:white;}
    .btn-primary:hover{background:var(--blue-d);}
    .btn-secondary{background:white;color:var(--text2);border:1.5px solid var(--border);}
    .btn-secondary:hover{border-color:var(--border-d);color:var(--text);}
    .btn-sm{padding:6px 12px;font-size:12px;}
    .overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,0.4);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
    .overlay.open{display:flex;}
    .modal{background:white;border-radius:14px;box-shadow:var(--shadow-l);width:620px;max-height:88vh;overflow-y:auto;animation:fadeUp 0.2s ease;border:1px solid var(--border);}
    .modal-lg{width:760px;}
    .modal-header{display:flex;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);gap:12px;position:sticky;top:0;background:white;z-index:2;border-radius:14px 14px 0 0;}
    .modal-header h3{font-size:16px;font-weight:600;flex:1;}
    .modal-close{width:30px;height:30px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;font-size:16px;color:var(--text2);display:flex;align-items:center;justify-content:center;}
    .modal-close:hover{background:var(--border);color:var(--text);}
    .modal-body{padding:24px;}
    .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;position:sticky;bottom:0;background:white;border-radius:0 0 14px 14px;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .form-group{display:flex;flex-direction:column;gap:5px;}
    .form-group.full{grid-column:1/-1;}
    label{font-size:12px;font-weight:500;color:var(--text2);}
    input[type="text"],input[type="date"],input[type="url"],input[type="email"],select,textarea{background:white;border:1.5px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;font-family:var(--sans);padding:9px 12px;outline:none;width:100%;transition:border-color 0.2s;}
    input:focus,select:focus,textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-l);}
    textarea{resize:vertical;min-height:72px;}
    .url-row{display:flex;gap:0;}
    .url-row input{border-radius:7px 0 0 7px;flex:1;}
    .url-open{display:flex;align-items:center;padding:0 12px;background:var(--bg);border:1.5px solid var(--border);border-left:none;border-radius:0 7px 7px 0;color:var(--blue);text-decoration:none;font-size:14px;transition:background 0.15s;}
    .url-open:hover{background:var(--blue-l);}
    .section-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;padding:16px 0 8px;border-bottom:1px solid var(--border);margin-bottom:16px;grid-column:1/-1;}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;}
    .detail-field label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:block;}
    .detail-field .val{font-size:14px;color:var(--text);}
    .detail-field .val.mono{font-family:var(--mono);font-size:13px;}
    .historial-list{display:flex;flex-direction:column;gap:0;}
    .historial-item{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);}
    .historial-item:last-child{border-bottom:none;}
    .hist-dot{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;margin-top:2px;}
    .hist-dot.creacion{background:var(--blue-l);color:var(--blue);}
    .hist-dot.edicion{background:var(--warning-l);color:var(--warning);}
    .hist-dot.eliminacion{background:var(--danger-l);color:var(--danger);}
    .hist-body{flex:1;}
    .hist-desc{font-size:13px;font-weight:500;color:var(--text);margin-bottom:4px;}
    .hist-meta{font-size:11px;color:var(--text3);}
    .hist-cambios{margin-top:8px;display:flex;flex-direction:column;gap:4px;}
    .hist-cambio{display:flex;align-items:center;gap:6px;font-size:11px;background:var(--bg);border-radius:6px;padding:4px 8px;}
    .hist-campo{font-weight:600;color:var(--text2);min-width:80px;}
    .hist-antes{color:var(--danger);text-decoration:line-through;}
    .hist-arr{color:var(--text3);}
    .hist-despues{color:var(--success);font-weight:500;}
    .empty{text-align:center;padding:60px 20px;color:var(--text3);}
    .empty-icon{font-size:36px;margin-bottom:12px;}
    #toast{position:fixed;bottom:24px;right:24px;z-index:300;display:flex;flex-direction:column;gap:8px;}
    .toast-msg{padding:12px 18px;background:var(--slate);color:white;border-radius:8px;font-size:13px;box-shadow:var(--shadow-m);animation:slideIn 0.2s ease;max-width:320px;display:flex;align-items:center;gap:8px;}
    .toast-msg.success{background:var(--success);}
    .toast-msg.error{background:var(--danger);}
    .toast-msg.info{background:var(--blue);}
    .loader-row td{padding:40px;text-align:center;color:var(--text3);font-size:13px;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    @keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
    ::-webkit-scrollbar{width:5px;height:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--border-d);border-radius:99px;}
    @media(max-width:900px){
      .sidebar{width:56px;}
      .login-brand-icon{width:32px;height:32px;}
      .sidebar-brand-icon{width:28px;height:28px;}
      .sidebar-brand-name,.sidebar-brand-sub,.nav-section,.nav-item span,.user-name,.user-email,.btn-logout{display:none;}
      .nav-item{justify-content:center;padding:10px;}
      .charts-row{grid-template-columns:1fr;}
      .form-grid{grid-template-columns:1fr;}
      .detail-grid{grid-template-columns:1fr;}
    }
    @media(max-width:420px){
      .login-brand-icon{width:28px;height:28px;}
      .sidebar-brand-icon{width:24px;height:24px;}
    }
  </style>
</head>
<body>

<div id="login-screen">
  <div class="login-card">
    <div class="login-brand">
      <div class="login-brand-icon"><img src="img/logo.jpg" alt="InventaTI" width="40" height="40" decoding="async" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;display:block"></div>
      <div>
        <div style="font-size:20px;font-weight:600">Inventario Clientes An√≥nimos</div>
        <div style="font-size:11px;color:var(--text3)">Gesti√≥n de Activos TI_CA</div>
      </div>
    </div>
    <h1 class="login-title">Bienvenido</h1>
    <p class="login-sub">Accede con tu cuenta corporativa de Google. Solo personal autorizado puede ingresar.</p>
    <div id="login-error" class="error-banner"></div>
    <a class="btn-google" id="btn-login" href="#">
      <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Continuar con Google
    </a>
    <p class="login-note">üîí Acceso restringido a correos autorizados</p>
  </div>
</div>

<div id="app">
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="sidebar-brand-icon"><img src="img/logo.jpg" alt="InventaTI" width="34" height="34" decoding="async" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;display:block"></div>
          <div>
            <div class="sidebar-brand-name">Clientes An√≥nimos</div>
            <div class="sidebar-brand-sub">Inventario de Activos TI</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">Principal</div>
        <div class="nav-item active" data-view="dashboard" onclick="showView('dashboard')"><span class="ni">üìä</span><span>Dashboard</span></div>
        <div class="nav-section">Inventario</div>
        <div class="nav-item" data-view="inventario" onclick="showView('inventario')"><span class="ni">üìã</span><span>Inventario General</span></div>
        <div class="nav-item" data-view="por-colaborador" onclick="showView('por-colaborador')"><span class="ni">üë§</span><span>Por Colaborador</span></div>
        <div class="nav-item" data-view="remotos" onclick="showView('remotos')"><span class="ni">üè†</span><span>Equipos Remotos</span></div>
        <div class="nav-item" data-view="oficina" onclick="showView('oficina')"><span class="ni">üè¢</span><span>En Oficina</span></div>
        <div class="nav-item" data-view="por-area" onclick="showView('por-area')"><span class="ni">üóÇÔ∏è</span><span>Por √Årea</span></div>
        <div class="nav-section">Personas</div>
        <div class="nav-item" data-view="colaboradores" onclick="showView('colaboradores')"><span class="ni">üë•</span><span>Colaboradores</span></div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-row">
          <div class="user-ava"><img id="user-photo" src="" alt="" onerror="this.style.display='none'"><span id="user-initial"></span></div>
          <div><div class="user-name" id="user-name">‚Äî</div><div class="user-email" id="user-email">‚Äî</div></div>
        </div>
        <button class="btn-logout" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
    </aside>

    <div class="main">
      <div class="topbar">
        <span class="topbar-title" id="topbar-title">Dashboard</span>
        <div class="search-box" id="search-box" style="display:none">
          <span style="color:var(--text3);font-size:13px">üîç</span>
          <input type="text" id="global-search" placeholder="Buscar activo, usuario, serie..." oninput="handleSearch(this.value)">
        </div>
        <button class="btn btn-primary btn-sm" id="btn-add" style="display:none" onclick="handleAdd()">+ Nuevo</button>
      </div>
      <div class="content">

        <div class="view active" id="view-dashboard">
          <div class="stats-grid" id="stats-grid"><div style="padding:20px;color:var(--text3)">Cargando...</div></div>
          <div class="charts-row">
            <div class="chart-card"><div class="chart-title">Estado de activos</div><div id="chart-estado"></div></div>
            <div class="chart-card"><div class="chart-title">Tipos de equipo</div><div id="chart-tipo"></div></div>
          </div>
          <div class="chart-card"><div class="chart-title">Activos por √°rea</div><div id="chart-area"></div></div>
        </div>

        <div class="view" id="view-inventario">
          <div class="table-card">
            <div class="table-toolbar">
              <h2>Inventario General</h2>
              <div class="filter-group">
                <select class="filter" id="f-estado" onchange="loadInventario()">
                  <option value="">Todos los estados</option>
                  <option>Asignado</option><option>En oficina</option><option>En almac√©n</option><option>En reparaci√≥n</option><option>Baja</option>
                </select>
                <select class="filter" id="f-tipo" onchange="loadInventario()">
                  <option value="">Todos los tipos</option>
                  <option>Laptop</option><option>Mouse</option><option>Teclado</option><option>Monitor</option>
                  <option>Impresora</option><option>Router</option><option>Chip</option><option>Aud√≠fono</option><option>Celular</option><option>PC</option>
                </select>
                <select class="filter" id="f-area" onchange="loadInventario()">
                  <option value="">Todas las √°reas</option>
                  <option>Administraci√≥n y Finanzas</option><option>Gerencia</option><option>Talento y Cultura</option>
                  <option>Mystery Shopping</option><option>Driver Panel</option><option>Market Research</option>
                  <option>Bid Ask</option><option>Comunicaciones</option><option>Comercial</option>
                </select>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>Tipo</th><th>Marca / Modelo</th><th>N¬∞ Serie</th><th>Estado</th><th>Ubicaci√≥n</th><th>Usuario</th><th>√Årea</th><th>F. Entrega</th><th>Constancias</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-inventario"><tr class="loader-row"><td colspan="11">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="view" id="view-por-colaborador">
          <div class="table-card">
            <div class="table-toolbar"><h2>Equipos por Colaborador</h2></div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>Usuario</th><th>Tipo</th><th>Marca / Modelo</th><th>Estado</th><th>√Årea</th><th>F. Entrega</th><th>Constancia</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-colaborador"><tr class="loader-row"><td colspan="9">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="view" id="view-remotos">
          <div class="table-card">
            <div class="table-toolbar"><h2>Equipos Remotos</h2></div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>Tipo</th><th>Marca / Modelo</th><th>Estado</th><th>Usuario</th><th>√Årea</th><th>F. Entrega</th><th>Constancia</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-remotos"><tr class="loader-row"><td colspan="9">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="view" id="view-oficina">
          <div class="table-card">
            <div class="table-toolbar"><h2>Equipos en Oficina</h2></div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>Tipo</th><th>Marca / Modelo</th><th>Estado</th><th>Usuario</th><th>√Årea</th><th>F. Entrega</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-oficina"><tr class="loader-row"><td colspan="8">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="view" id="view-por-area">
          <div class="table-card">
            <div class="table-toolbar">
              <h2>Equipos por √Årea</h2>
              <select class="filter" id="f-area2" onchange="loadPorArea()">
                <option value="">Todas las √°reas</option>
                <option>Administraci√≥n y Finanzas</option><option>Gerencia</option><option>Talento y Cultura</option>
                <option>Mystery Shopping</option><option>Driver Panel</option><option>Market Research</option>
                <option>Bid Ask</option><option>Comunicaciones</option><option>Comercial</option>
              </select>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>√Årea</th><th>Tipo</th><th>Marca / Modelo</th><th>Estado</th><th>Ubicaci√≥n</th><th>Usuario</th><th>F. Entrega</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-area"><tr class="loader-row"><td colspan="9">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="view" id="view-colaboradores">
          <div class="table-card">
            <div class="table-toolbar">
              <h2>Colaboradores</h2>
              <div class="filter-group">
                <select class="filter" id="f-col-estado" onchange="loadColaboradores()">
                  <option value="">Todos</option><option>Activo</option><option>Inactivo</option><option>Cesado</option>
                </select>
                <select class="filter" id="f-col-area" onchange="loadColaboradores()">
                  <option value="">Todas las √°reas</option>
                  <option>Administraci√≥n y Finanzas</option><option>Gerencia</option><option>Talento y Cultura</option>
                  <option>Mystery Shopping</option><option>Driver Panel</option><option>Market Research</option>
                  <option>Bid Ask</option><option>Comunicaciones</option><option>Comercial</option>
                </select>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>√Årea</th><th>Modalidad</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="tbody-colaboradores"><tr class="loader-row"><td colspan="8">Cargando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- MODAL ACTIVO -->
<div class="overlay" id="modal-asset">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-asset-title">Nuevo Activo</h3>
      <button class="modal-close" onclick="closeModal('modal-asset')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ID *</label><input type="text" id="f-id" placeholder="LAP-001" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="form-group"><label>Tipo de Equipo *</label>
          <select id="f-tipoEquipo"><option>Laptop</option><option>Mouse</option><option>Teclado</option><option>Monitor</option><option>Impresora</option><option>Router</option><option>Chip</option><option>Aud√≠fono</option><option>Celular</option><option>PC</option><option>Otro</option></select>
        </div>
        <div class="form-group"><label>Marca</label><input type="text" id="f-marca" placeholder="Apple, HP, Lenovo..."></div>
        <div class="form-group"><label>Modelo</label><input type="text" id="f-modelo" placeholder="MacBook Air, HP ZBook..."></div>
        <div class="form-group"><label>N¬∞ Serie / N¬∞ Tel√©fono</label><input type="text" id="f-serie" placeholder="SN123456"></div>
        <div class="form-group"><label>Estado *</label>
          <select id="f-estado-m"><option>Asignado</option><option>En oficina</option><option>En almac√©n</option><option>En reparaci√≥n</option><option>Baja</option></select>
        </div>
        <div class="form-group"><label>Ubicaci√≥n</label>
          <select id="f-ubicacion"><option value="">‚Äî Sin especificar ‚Äî</option><option>Casa (Remoto)</option><option>Oficina</option><option>Almac√©n</option></select>
        </div>
        <div class="form-group"><label>√Årea</label>
          <select id="f-area-m"><option value="">‚Äî Sin especificar ‚Äî</option><option>Administraci√≥n y Finanzas</option><option>Gerencia</option><option>Talento y Cultura</option><option>Mystery Shopping</option><option>Driver Panel</option><option>Market Research</option><option>Bid Ask</option><option>Comunicaciones</option><option>Comercial</option></select>
        </div>
        <div class="form-group full"><label>Usuario Asignado</label><input type="text" id="f-usuario" placeholder="Nombre completo" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="form-group"><label>Fecha de Entrega</label><input type="date" id="f-fecha"></div>
        <div class="form-group full"><label>Observaciones</label><textarea id="f-obs" placeholder="Notas adicionales..."></textarea></div>
        <div class="section-label">üîó Links de Constancias (Google Drive u otro)</div>
        <div class="form-group full"><label>Constancia de Entrega</label><div class="url-row"><input type="url" id="f-c-entrega" placeholder="https://drive.google.com/..."><a id="la-entrega" href="#" target="_blank" class="url-open">‚Üó</a></div></div>
        <div class="form-group full"><label>Constancia de Cambio</label><div class="url-row"><input type="url" id="f-c-cambio" placeholder="https://drive.google.com/..."><a id="la-cambio" href="#" target="_blank" class="url-open">‚Üó</a></div></div>
        <div class="form-group full"><label>Constancia de Devoluci√≥n</label><div class="url-row"><input type="url" id="f-c-devolucion" placeholder="https://drive.google.com/..."><a id="la-devolucion" href="#" target="_blank" class="url-open">‚Üó</a></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-asset')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveAsset()">Guardar cambios</button>
    </div>
  </div>
</div>

<!-- MODAL DETALLE -->
<div class="overlay" id="modal-detalle">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3 id="detalle-title">Detalle del Activo</h3>
      <button class="modal-close" onclick="closeModal('modal-detalle')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="detalle-grid"></div>
      <div style="border-top:1px solid var(--border);padding-top:20px;margin-top:4px">
        <div style="font-size:14px;font-weight:600;margin-bottom:16px;">üìú Historial de cambios</div>
        <div class="historial-list" id="historial-list"><div style="color:var(--text3);font-size:13px">Cargando historial...</div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-detalle')">Cerrar</button>
      <button class="btn btn-primary" id="btn-editar-desde-detalle">‚úé Editar</button>
    </div>
  </div>
</div>

<!-- MODAL COLABORADOR -->
<div class="overlay" id="modal-collab">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-collab-title">Nuevo Colaborador</h3>
      <button class="modal-close" onclick="closeModal('modal-collab')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ID Empleado (DNI) *</label><input type="text" id="c-id" placeholder="12345678"></div>
        <div class="form-group"><label>Estado</label><select id="c-estado"><option>Activo</option><option>Inactivo</option><option>Cesado</option></select></div>
        <div class="form-group full"><label>Nombre Completo *</label><input type="text" id="c-nombre" placeholder="APELLIDO NOMBRE" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="form-group"><label>Email</label><input type="email" id="c-email" placeholder="correo@empresa.com"></div>
        <div class="form-group"><label>Tel√©fono</label><input type="text" id="c-tel" placeholder="999 888 777"></div>
        <div class="form-group"><label>√Årea</label>
          <select id="c-area"><option value="">‚Äî Sin especificar ‚Äî</option><option>Administraci√≥n y Finanzas</option><option>Gerencia</option><option>Talento y Cultura</option><option>Mystery Shopping</option><option>Driver Panel</option><option>Market Research</option><option>Bid Ask</option><option>Comunicaciones</option><option>Comercial</option></select>
        </div>
        <div class="form-group"><label>Modalidad</label>
          <select id="c-modalidad"><option value="">‚Äî Sin especificar ‚Äî</option><option>Remoto</option><option>Presencial</option><option>H√≠brido</option></select>
        </div>
        <div class="form-group full"><label>Observaciones</label><textarea id="c-obs"></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-collab')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveColaborador()">Guardar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API = window.__API_BASE__
  || document.querySelector('meta[name="api-base-url"]')?.content
  || localStorage.getItem('API_BASE_URL')
  || (window.location.hostname === 'localhost' ? 'http://localhost:3001' : '');
let currentView='dashboard',editingAssetId=null,editingCollabId=null,searchQ='',searchTimer=null;
if(!API){console.warn('API base URL no configurada. Define window.__API_BASE__ o <meta name="api-base-url"> para producci√≥n.');}
let currentUserRole='viewer'; // 'admin' | 'viewer'

async function init(){
  const params=new URLSearchParams(location.search);
  if(params.get('error')==='acceso_denegado'){const el=document.getElementById('login-error');el.textContent='‚ùå Tu correo no est√° autorizado.';el.style.display='block';}
  try{const res=await fetch(`${API}/auth/me`,{credentials:'include'});const data=await res.json();if(data.authenticated)showApp(data.user);else showLogin();}catch{showLogin();}
}

function showLogin(){document.getElementById('login-screen').style.display='flex';document.getElementById('app').style.display='none';document.getElementById('btn-login').href=`${API}/auth/google`;}

function showApp(user){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('user-name').textContent=user.name.split(' ')[0];
  document.getElementById('user-email').textContent=user.email;
  document.getElementById('user-initial').textContent=user.name[0].toUpperCase();
  // role provided by backend (admin | viewer)
  currentUserRole = user.role || 'viewer';
  // show/hide add button according to role and current view
  const addBtn = document.getElementById('btn-add');
  if(addBtn) addBtn.style.display = (viewsWithAdd.includes(currentView) && currentUserRole === 'admin') ? 'flex' : 'none';
  if(user.photo){const img=document.getElementById('user-photo');img.src=user.photo;img.style.display='block';document.getElementById('user-initial').style.display='none';}
  loadDashboard();
}

async function logout(){await fetch(`${API}/auth/logout`,{method:'POST',credentials:'include'});showLogin();}

const viewTitles={dashboard:'Dashboard',inventario:'Inventario General','por-colaborador':'Equipos por Colaborador',remotos:'Equipos Remotos',oficina:'Equipos en Oficina','por-area':'Equipos por √Årea',colaboradores:'Colaboradores'};
const viewsWithSearch=['inventario','por-colaborador','remotos','oficina','por-area'];
const viewsWithAdd=['inventario','por-colaborador','remotos','oficina','por-area','colaboradores'];

function showView(view){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  document.querySelector(`[data-view="${view}"]`).classList.add('active');
  document.getElementById('topbar-title').textContent=viewTitles[view];
  document.getElementById('search-box').style.display=viewsWithSearch.includes(view)?'flex':'none';
  // Mostrar bot√≥n +Nuevo solo si la vista lo permite y el usuario es admin
  document.getElementById('btn-add').style.display=(viewsWithAdd.includes(view) && currentUserRole==='admin')?'flex':'none';
  currentView=view;searchQ='';
  const inp=document.getElementById('global-search');if(inp)inp.value='';
  const loaders={dashboard:loadDashboard,inventario:loadInventario,'por-colaborador':loadPorColaborador,remotos:loadRemotos,oficina:loadOficina,'por-area':loadPorArea,colaboradores:loadColaboradores};
  if(loaders[view])loaders[view]();
}

function handleAdd(){if(currentView==='colaboradores')openAddCollab();else openAddAsset();}

function handleSearch(val){searchQ=val;clearTimeout(searchTimer);searchTimer=setTimeout(()=>{const map={inventario:loadInventario,'por-colaborador':loadPorColaborador,remotos:loadRemotos,oficina:loadOficina,'por-area':loadPorArea};if(map[currentView])map[currentView]();},300);}

async function api(url,opts={}){
  const res=await fetch(`${API}${url}`,{credentials:'include',...opts,headers:{'Content-Type':'application/json',...(opts.headers||{})}});
  if(res.status===401){showLogin();return null;}
  return res;
}

async function loadDashboard(){
  const res=await api('/api/assets/stats');if(!res)return;
  const d=await res.json();
  const byEstado=Object.fromEntries(d.byEstado.map(x=>[x._id,x.count]));
  document.getElementById('stats-grid').innerHTML=`
    <div class="stat-card"><div class="stat-top"><div class="stat-icon blue">üì¶</div></div><div class="stat-value">${d.total}</div><div class="stat-label">Total activos</div></div>
    <div class="stat-card"><div class="stat-top"><div class="stat-icon blue">‚úÖ</div></div><div class="stat-value">${byEstado['Asignado']||0}</div><div class="stat-label">Asignados</div></div>
    <div class="stat-card"><div class="stat-top"><div class="stat-icon green">üè¢</div></div><div class="stat-value">${byEstado['En oficina']||0}</div><div class="stat-label">En oficina</div></div>
    <div class="stat-card"><div class="stat-top"><div class="stat-icon yellow">‚öôÔ∏è</div></div><div class="stat-value">${byEstado['En reparaci√≥n']||0}</div><div class="stat-label">En reparaci√≥n</div></div>
    <div class="stat-card"><div class="stat-top"><div class="stat-icon orange">üì•</div></div><div class="stat-value">${byEstado['En almac√©n']||0}</div><div class="stat-label">En almac√©n</div></div>
    <div class="stat-card"><div class="stat-top"><div class="stat-icon red">üóëÔ∏è</div></div><div class="stat-value">${byEstado['Baja']||0}</div><div class="stat-label">De baja</div></div>`;
  renderBars('chart-estado',d.byEstado);renderBars('chart-tipo',d.byTipo);renderBars('chart-area',d.byArea);
}

function renderBars(id,items){
  const sorted=[...items].sort((a,b)=>b.count-a.count);const max=sorted[0]?.count||1;
  document.getElementById(id).innerHTML=sorted.map(item=>`<div class="bar-row"><div class="bar-label">${item._id||'‚Äî'}</div><div class="bar-track"><div class="bar-fill" style="width:${(item.count/max*100).toFixed(1)}%"></div></div><div class="bar-count">${item.count}</div></div>`).join('');
}

async function loadInventario(){
  const estado=document.getElementById('f-estado').value,tipo=document.getElementById('f-tipo').value,area=document.getElementById('f-area').value;
  const qs=new URLSearchParams();if(estado)qs.set('estado',estado);if(tipo)qs.set('tipoEquipo',tipo);if(area)qs.set('area',area);if(searchQ)qs.set('search',searchQ);
  const tbody=document.getElementById('tbody-inventario');tbody.innerHTML='<tr class="loader-row"><td colspan="11">Cargando...</td></tr>';
  const res=await api(`/api/assets?${qs}`);if(!res)return;
  const{assets}=await res.json();
  tbody.innerHTML=assets.length?assets.map(a=>`<tr>
    <td class="td-id">${a.id}</td><td>${a.tipoEquipo}</td>
    <td class="td-name">${[a.marca,a.modelo].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><span style="font-family:var(--mono);font-size:11px">${a.numeroSerie||'‚Äî'}</span></td>
    <td><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></td>
    <td>${a.ubicacion||'‚Äî'}</td><td>${a.usuarioAsignado||'‚Äî'}</td><td>${a.area||'‚Äî'}</td>
    <td style="font-size:12px">${fmtDate(a.fechaEntrega)}</td>
    <td>${linkPill(a.constanciaEntrega,'E')}${linkPill(a.constanciaCambio,'C')}${linkPill(a.constanciaDevolucion,'D')}</td>
    <td><div class="action-row">
      <button class="btn-icon view" onclick="verDetalle('${a.id}')">üëÅ</button>
      ${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editAsset('${a.id}')">‚úé</button><button class="btn-icon del" onclick="deleteAsset('${a.id}')">üóë</button>`:''}
    </div></td></tr>`).join(''):'<tr><td colspan="11"><div class="empty"><div class="empty-icon">üìã</div><div>Sin resultados</div></div></td></tr>';
}

async function loadPorColaborador(){
  const tbody=document.getElementById('tbody-colaborador');tbody.innerHTML='<tr class="loader-row"><td colspan="9">Cargando...</td></tr>';
  const qs=searchQ?`?search=${encodeURIComponent(searchQ)}`:'';
  const res=await api(`/api/assets${qs}`);if(!res)return;
  const{assets}=await res.json();
  const sorted=assets.filter(a=>a.usuarioAsignado).sort((a,b)=>(a.usuarioAsignado||'').localeCompare(b.usuarioAsignado||''));
  tbody.innerHTML=sorted.length?sorted.map(a=>`<tr>
    <td class="td-id">${a.id}</td><td class="td-name">${a.usuarioAsignado||'‚Äî'}</td><td>${a.tipoEquipo}</td>
    <td>${[a.marca,a.modelo].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></td>
    <td>${a.area||'‚Äî'}</td><td style="font-size:12px">${fmtDate(a.fechaEntrega)}</td>
    <td>${linkPill(a.constanciaEntrega,'Entrega')}</td>
    <td><div class="action-row"><button class="btn-icon view" onclick="verDetalle('${a.id}')">üëÅ</button>${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editAsset('${a.id}')">‚úé</button>`:''}</div></td>
  </tr>`).join(''):'<tr><td colspan="9"><div class="empty"><div class="empty-icon">üë§</div><div>Sin equipos asignados</div></div></td></tr>';
}

async function loadRemotos(){
  await loadFiltered('tbody-remotos',9,{ubicacion:'Casa (Remoto)'},a=>`<tr>
    <td class="td-id">${a.id}</td><td>${a.tipoEquipo}</td><td>${[a.marca,a.modelo].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></td>
    <td>${a.usuarioAsignado||'‚Äî'}</td><td>${a.area||'‚Äî'}</td><td style="font-size:12px">${fmtDate(a.fechaEntrega)}</td>
    <td>${linkPill(a.constanciaEntrega,'Entrega')}</td>
    <td><div class="action-row"><button class="btn-icon view" onclick="verDetalle('${a.id}')">üëÅ</button>${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editAsset('${a.id}')">‚úé</button>`:''}</div></td>
  </tr>`);
}

async function loadOficina(){
  await loadFiltered('tbody-oficina',8,{ubicacion:'Oficina'},a=>`<tr>
    <td class="td-id">${a.id}</td><td>${a.tipoEquipo}</td><td>${[a.marca,a.modelo].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></td>
    <td>${a.usuarioAsignado||'‚Äî'}</td><td>${a.area||'‚Äî'}</td><td style="font-size:12px">${fmtDate(a.fechaEntrega)}</td>
    <td><div class="action-row"><button class="btn-icon view" onclick="verDetalle('${a.id}')">üëÅ</button>${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editAsset('${a.id}')">‚úé</button>`:''}</div></td>
  </tr>`);
}

async function loadFiltered(tbodyId,cols,extraFilter,rowFn){
  const tbody=document.getElementById(tbodyId);tbody.innerHTML=`<tr class="loader-row"><td colspan="${cols}">Cargando...</td></tr>`;
  const qs=new URLSearchParams({...extraFilter,...(searchQ?{search:searchQ}:{})});
  const res=await api(`/api/assets?${qs}`);if(!res)return;
  const{assets}=await res.json();
  tbody.innerHTML=assets.length?assets.map(rowFn).join(''):`<tr><td colspan="${cols}"><div class="empty"><div class="empty-icon">üì¶</div><div>Sin resultados</div></div></td></tr>`;
}

async function loadPorArea(){
  const area=document.getElementById('f-area2').value;
  const tbody=document.getElementById('tbody-area');tbody.innerHTML='<tr class="loader-row"><td colspan="9">Cargando...</td></tr>';
  const qs=new URLSearchParams({...(area?{area}:{}),...(searchQ?{search:searchQ}:{})});
  const res=await api(`/api/assets?${qs}`);if(!res)return;
  const{assets}=await res.json();
  const sorted=[...assets].sort((a,b)=>(a.area||'').localeCompare(b.area||''));
  tbody.innerHTML=sorted.length?sorted.map(a=>`<tr>
    <td class="td-id">${a.id}</td><td>${a.area||'‚Äî'}</td><td>${a.tipoEquipo}</td>
    <td>${[a.marca,a.modelo].filter(Boolean).join(' ')||'‚Äî'}</td>
    <td><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></td>
    <td>${a.ubicacion||'‚Äî'}</td><td>${a.usuarioAsignado||'‚Äî'}</td><td style="font-size:12px">${fmtDate(a.fechaEntrega)}</td>
    <td><div class="action-row"><button class="btn-icon view" onclick="verDetalle('${a.id}')">üëÅ</button>${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editAsset('${a.id}')">‚úé</button>`:''}</div></td>
  </tr>`).join(''):'<tr><td colspan="9"><div class="empty"><div class="empty-icon">üóÇÔ∏è</div><div>Sin resultados</div></div></td></tr>';
}

async function loadColaboradores(){
  const estado=document.getElementById('f-col-estado').value,area=document.getElementById('f-col-area').value;
  const tbody=document.getElementById('tbody-colaboradores');tbody.innerHTML='<tr class="loader-row"><td colspan="8">Cargando...</td></tr>';
  const qs=new URLSearchParams({...(estado?{estado}:{}),...(area?{area}:{})});
  const res=await api(`/api/colaboradores?${qs}`);if(!res)return;
  const data=await res.json();
  tbody.innerHTML=data.length?data.map(c=>`<tr>
    <td class="td-id">${c.idEmpleado}</td><td class="td-name">${c.nombreCompleto}</td>
    <td style="font-size:12px">${c.email||'‚Äî'}</td><td>${c.telefono||'‚Äî'}</td>
    <td>${c.area||'‚Äî'}</td><td>${c.modalidad||'‚Äî'}</td>
    <td><span class="badge badge-${(c.estado||'').toLowerCase()}">${c.estado}</span></td>
    <td><div class="action-row">${currentUserRole==='admin'?`<button class="btn-icon edit" onclick="editColaborador('${c._id}')">‚úé</button><button class="btn-icon del" onclick="deleteColaborador('${c._id}')">üóë</button>`:''}</div></td>
  </tr>`).join(''):'<tr><td colspan="8"><div class="empty"><div class="empty-icon">üë•</div><div>Sin colaboradores</div></div></td></tr>';
}

async function verDetalle(id){
  const[resA,resH]=await Promise.all([api(`/api/assets/${id}`),api(`/api/assets/${id}/historial`)]);
  if(!resA)return;
  const a=await resA.json();const historial=resH?await resH.json():[];
  document.getElementById('detalle-title').textContent=`${a.id} ‚Äî ${a.tipoEquipo}`;
  const btnEditarDetalle = document.getElementById('btn-editar-desde-detalle');
  // Mostrar el bot√≥n de editar solo para admins
  btnEditarDetalle.style.display = currentUserRole==='admin' ? 'inline-flex' : 'none';
  btnEditarDetalle.onclick=()=>{closeModal('modal-detalle');if(currentUserRole==='admin')editAsset(id);else toast('No autorizado','error');};
  document.getElementById('detalle-grid').innerHTML=`
    <div class="detail-field"><label>ID</label><div class="val mono">${a.id}</div></div>
    <div class="detail-field"><label>Tipo</label><div class="val">${a.tipoEquipo}</div></div>
    <div class="detail-field"><label>Marca</label><div class="val">${a.marca||'‚Äî'}</div></div>
    <div class="detail-field"><label>Modelo</label><div class="val">${a.modelo||'‚Äî'}</div></div>
    <div class="detail-field"><label>N¬∞ Serie</label><div class="val mono">${a.numeroSerie||'‚Äî'}</div></div>
    <div class="detail-field"><label>Estado</label><div class="val"><span class="badge ${badgeCls(a.estado)}">${a.estado}</span></div></div>
    <div class="detail-field"><label>Ubicaci√≥n</label><div class="val">${a.ubicacion||'‚Äî'}</div></div>
    <div class="detail-field"><label>√Årea</label><div class="val">${a.area||'‚Äî'}</div></div>
    <div class="detail-field"><label>Usuario Asignado</label><div class="val">${a.usuarioAsignado||'‚Äî'}</div></div>
    <div class="detail-field"><label>Fecha de Entrega</label><div class="val">${fmtDate(a.fechaEntrega)}</div></div>
    <div class="detail-field"><label>Constancia Entrega</label><div class="val">${a.constanciaEntrega?`<a href="${a.constanciaEntrega}" target="_blank" class="link-pill">‚Üó Abrir</a>`:'‚Äî'}</div></div>
    <div class="detail-field"><label>Constancia Cambio</label><div class="val">${a.constanciaCambio?`<a href="${a.constanciaCambio}" target="_blank" class="link-pill">‚Üó Abrir</a>`:'‚Äî'}</div></div>
    <div class="detail-field"><label>Constancia Devoluci√≥n</label><div class="val">${a.constanciaDevolucion?`<a href="${a.constanciaDevolucion}" target="_blank" class="link-pill">‚Üó Abrir</a>`:'‚Äî'}</div></div>
    <div class="detail-field"><label>Observaciones</label><div class="val">${a.observaciones||'‚Äî'}</div></div>`;
  const iconos={creacion:'‚ûï',edicion:'‚úèÔ∏è',eliminacion:'üóëÔ∏è',entrega:'üì¨',cambio:'üîÑ',devolucion:'‚Ü©Ô∏è'};
  document.getElementById('historial-list').innerHTML=historial.length?historial.map(h=>`
    <div class="historial-item">
      <div class="hist-dot ${h.tipo}">${iconos[h.tipo]||'‚Ä¢'}</div>
      <div class="hist-body">
        <div class="hist-desc">${h.descripcion}</div>
        <div class="hist-meta">${fmtDateTime(h.fecha)}${h.usuario?` ¬∑ ${h.usuario}`:''}</div>
        ${h.cambios?.length?`<div class="hist-cambios">${h.cambios.map(c=>`<div class="hist-cambio"><span class="hist-campo">${c.campo}</span><span class="hist-antes">${c.valorAnterior||'vac√≠o'}</span><span class="hist-arr">‚Üí</span><span class="hist-despues">${c.valorNuevo||'vac√≠o'}</span></div>`).join('')}</div>`:''}
      </div>
    </div>`).join(''):'<div style="color:var(--text3);font-size:13px;padding:12px 0">Sin historial registrado a√∫n.</div>';
  openModal('modal-detalle');
}

function openAddAsset(){
  if(currentUserRole!=='admin'){toast('No autorizado','error');return;}
  editingAssetId=null;
  document.getElementById('modal-asset-title').textContent='Nuevo Activo';
  ['f-id','f-marca','f-modelo','f-serie','f-usuario','f-fecha','f-obs','f-c-entrega','f-c-cambio','f-c-devolucion'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-id').disabled=false;
  document.getElementById('f-estado-m').value='En almac√©n';
  document.getElementById('f-ubicacion').value='';document.getElementById('f-area-m').value='';
  openModal('modal-asset');
}

async function editAsset(id){
  const res=await api(`/api/assets/${id}`);if(!res)return;
  const a=await res.json();editingAssetId=id;
  document.getElementById('modal-asset-title').textContent=`Editar ‚Äî ${id}`;
  document.getElementById('f-id').value=a.id;document.getElementById('f-id').disabled=true;
  document.getElementById('f-tipoEquipo').value=a.tipoEquipo;
  document.getElementById('f-marca').value=a.marca||'';document.getElementById('f-modelo').value=a.modelo||'';
  document.getElementById('f-serie').value=a.numeroSerie||'';document.getElementById('f-estado-m').value=a.estado;
  document.getElementById('f-ubicacion').value=a.ubicacion||'';document.getElementById('f-area-m').value=a.area||'';
  document.getElementById('f-usuario').value=a.usuarioAsignado||'';
  document.getElementById('f-fecha').value=a.fechaEntrega?a.fechaEntrega.slice(0,10):'';
  document.getElementById('f-obs').value=a.observaciones||'';
  document.getElementById('f-c-entrega').value=a.constanciaEntrega||'';
  document.getElementById('f-c-cambio').value=a.constanciaCambio||'';
  document.getElementById('f-c-devolucion').value=a.constanciaDevolucion||'';
  updateUrlLinks();openModal('modal-asset');
}

function updateUrlLinks(){
  [['f-c-entrega','la-entrega'],['f-c-cambio','la-cambio'],['f-c-devolucion','la-devolucion']].forEach(([inp,link])=>{
    const val=document.getElementById(inp).value;const a=document.getElementById(link);
    a.href=val||'#';a.style.opacity=val?'1':'0.4';
  });
}
['f-c-entrega','f-c-cambio','f-c-devolucion'].forEach(id=>document.getElementById(id).addEventListener('input',updateUrlLinks));

async function saveAsset(){
  if(currentUserRole!=='admin')return toast('No autorizado','error');
  const body={
    id:document.getElementById('f-id').value.trim().toUpperCase(),
    tipoEquipo:document.getElementById('f-tipoEquipo').value,
    marca:document.getElementById('f-marca').value.trim()||null,
    modelo:document.getElementById('f-modelo').value.trim()||null,
    numeroSerie:document.getElementById('f-serie').value.trim()||null,
    estado:document.getElementById('f-estado-m').value,
    ubicacion:document.getElementById('f-ubicacion').value||'',
    area:document.getElementById('f-area-m').value||null,
    usuarioAsignado:document.getElementById('f-usuario').value.trim().toUpperCase()||null,
    fechaEntrega:document.getElementById('f-fecha').value||null,
    observaciones:document.getElementById('f-obs').value.trim()||null,
    constanciaEntrega:document.getElementById('f-c-entrega').value.trim()||null,
    constanciaCambio:document.getElementById('f-c-cambio').value.trim()||null,
    constanciaDevolucion:document.getElementById('f-c-devolucion').value.trim()||null,
  };
  if(!body.id)return toast('El ID es obligatorio','error');
  const res=editingAssetId?await api(`/api/assets/${editingAssetId}`,{method:'PUT',body:JSON.stringify(body)}):await api('/api/assets',{method:'POST',body:JSON.stringify(body)});
  if(!res)return;if(!res.ok){const e=await res.json();return toast(e.error,'error');}
  toast(editingAssetId?'Activo actualizado ‚úì':'Activo creado ‚úì','success');
  closeModal('modal-asset');showView(currentView);
}

async function deleteAsset(id){
  if(currentUserRole!=='admin')return toast('No autorizado','error');
  if(!confirm(`¬øEliminar el activo ${id}?`))return;
  const res=await api(`/api/assets/${id}`,{method:'DELETE'});if(!res)return;
  toast('Activo eliminado','info');showView(currentView);
}

function openAddCollab(){
  if(currentUserRole!=='admin'){toast('No autorizado','error');return;}
  editingCollabId=null;
  document.getElementById('modal-collab-title').textContent='Nuevo Colaborador';
  ['c-id','c-nombre','c-email','c-tel','c-obs'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('c-estado').value='Activo';document.getElementById('c-area').value='';document.getElementById('c-modalidad').value='';
  openModal('modal-collab');
}

async function editColaborador(id){
  const res=await api(`/api/colaboradores/${id}`);if(!res)return;
  const c=await res.json();editingCollabId=id;
  document.getElementById('modal-collab-title').textContent=`Editar ‚Äî ${c.nombreCompleto}`;
  document.getElementById('c-id').value=c.idEmpleado;document.getElementById('c-nombre').value=c.nombreCompleto;
  document.getElementById('c-email').value=c.email||'';document.getElementById('c-tel').value=c.telefono||'';
  document.getElementById('c-area').value=c.area||'';document.getElementById('c-modalidad').value=c.modalidad||'';
  document.getElementById('c-estado').value=c.estado;document.getElementById('c-obs').value=c.observaciones||'';
  openModal('modal-collab');
}

async function saveColaborador(){
  if(currentUserRole!=='admin')return toast('No autorizado','error');
  const body={idEmpleado:document.getElementById('c-id').value.trim(),nombreCompleto:document.getElementById('c-nombre').value.trim().toUpperCase(),email:document.getElementById('c-email').value.trim().toLowerCase()||null,telefono:document.getElementById('c-tel').value.trim()||null,area:document.getElementById('c-area').value||null,modalidad:document.getElementById('c-modalidad').value||null,estado:document.getElementById('c-estado').value,observaciones:document.getElementById('c-obs').value.trim()||null};
  if(!body.idEmpleado||!body.nombreCompleto)return toast('ID y nombre son obligatorios','error');
  const res=editingCollabId?await api(`/api/colaboradores/${editingCollabId}`,{method:'PUT',body:JSON.stringify(body)}):await api('/api/colaboradores',{method:'POST',body:JSON.stringify(body)});
  if(!res)return;if(!res.ok){const e=await res.json();return toast(e.error,'error');}
  toast(editingCollabId?'Colaborador actualizado ‚úì':'Colaborador creado ‚úì','success');
  closeModal('modal-collab');loadColaboradores();
}

async function deleteColaborador(id){
  if(currentUserRole!=='admin')return toast('No autorizado','error');
  if(!confirm('¬øEliminar este colaborador?'))return;
  const res=await api(`/api/colaboradores/${id}`,{method:'DELETE'});if(!res)return;
  toast('Colaborador eliminado','info');loadColaboradores();
}

function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

function badgeCls(estado){return{'Asignado':'badge-asignado','En oficina':'badge-oficina','En almac√©n':'badge-almacen','En reparaci√≥n':'badge-reparacion','Baja':'badge-baja'}[estado]||'';}
function fmtDate(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('es-PE',{day:'2-digit',month:'2-digit',year:'numeric'});}
function fmtDateTime(d){if(!d)return'‚Äî';return new Date(d).toLocaleString('es-PE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function linkPill(url,label){if(!url)return'';return`<a class="link-pill" href="${url}" target="_blank" rel="noopener">‚Üó ${label}</a>`;}
function toast(msg,type='info'){const el=document.createElement('div');el.className=`toast-msg ${type}`;const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è'};el.innerHTML=`<span>${icons[type]||''}</span><span>${msg}</span>`;document.getElementById('toast').appendChild(el);setTimeout(()=>el.remove(),3500);}

init();
</script>
</body>
</html>
